<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件上传和打印</title>
    <script src="./js/vue.min.js"></script>
    <script src="./js/axios.min.js"></script>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            overflow: hidden;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        .file-input {
            margin-bottom: 20px;
        }

        .button-container {
            display: flex;
            justify-content: center;
        }

        .button-container button {
            margin: 0 10px;
        }

        .success-message {
            text-align: center;
            margin-top: 20px;
            color: green;
        }

        .error-message {
            text-align: center;
            margin-top: 20px;
            color: red;
        }

        h1 {
            color: #409EFF;
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
        }

        .el-table .success-row {
            background: #f0f9eb;
        }

        .el-table .selected-row {
            background: #c1fec0;
        }
    </style>
</head>

<body>
    <div id="app" class="container">

        <!-- <el-tooltip class="item" effect="dark" content="Bottom Center 提示文字" placement="bottom-end" color = "blue">
            <i class = "el-icon-user-solid"></i>
          </el-tooltip> -->
        <h1>文件上传和打印</h1>
        <el-table  @cell-click="(row,column)=>{if(column.label=='文件名')rFile= row;}" :row-class-name="tableRowClassName" :data="fileList"
            style="width: 400px" max-height="250">
            <el-table-column prop="filename" label="文件名">
            </el-table-column>
            <el-table-column align="center" width="50px" label="操作" >
                <template slot-scope="scope" >
                    <el-popover  placement="top-end" width="160" v-model="visible[scope.$index]">
                        <p>确定删除吗？</p>
                        <div style="text-align: right; margin: 0">
                            <el-button size="mini"  type="text" @click="$set(visible,scope.$index,false)">取消</el-button>
                            <el-button type="danger"  size="mini"  @click="$set(visible,scope.$index,false);handleDelete(scope.$index, scope.row)" >确定</el-button>
                        </div>
                        <el-button slot="reference" class="el-icon-delete" size="mini" type="danger" circle
                         ></el-button>
                    </el-popover>
                </template>
            </el-table-column>
        </el-table>
        <div class="file-input">
            <el-upload class="upload-demo" :limit="fileLimit" drag action="/upload" multiple :on-exceed="handleExceed"
                :before-upload="beforeUpload" :http-request="uploadFile">
                <i class="el-icon-upload"></i>
                <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                <div class="el-upload__tip" slot="tip">只能上传jpg/png/pdf文件，且不超过50mb</div>
            </el-upload>
        </div>
        <div class="button-container">
            <el-button type="primary" v-on:click="printFile" size = "large" icon="el-icon-printer"></el-button>
            <el-button type="primary" v-on:click="getFileList">所有文件</el-button>
            <el-button type="danger" v-on:click="logout" v-if="isLogin">登出</el-button>
            <el-button type="primary" v-on:click="login" v-else>登录</el-button>
        </div>
    </div>
    <script>
        const appVue = new Vue({
            el: '#app',
            data() {
                return {
                    isLogin: 0,
                    username: '',
                    file: null,
                    rFile: {timestamp:null},
                    error: null,
                    //上传后的文件列表
                    fileList: [],
                    // 允许的文件类型
                    fileType: ["pdf", "txt", "png", "jpg", "bmp", "jpeg"],
                    // 运行上传文件大小，单位 M
                    fileSize: 50,
                    // 附件数量限制
                    fileLimit: 0,
                    // 文件页数
                    pages: 0,
                    visible: []
                };
            },
            methods: {
                tableRowClassName({ row, rowIndex }) {
                    if (row.timestamp === this.rFile.timestamp) {
                        return 'selected-row';
                    }
                    return '';
                },
                beforeUpload(file) {
                    if (file.type != "" || file.type != null || file.type != undefined) {
                        //截取文件的后缀，判断文件类型
                        const FileExt = file.name.replace(/.+\./, "").toLowerCase();
                        //计算文件的大小
                        const isLt5M = file.size / 1024 / 1024 < 50; //这里做文件大小限制

                        //如果大于50M
                        if (!isLt5M) {
                            this.$message('上传文件大小不能超过 50MB!');
                            return false;
                        }
                        //如果文件类型不在允许上传的范围内
                        if (this.fileType.includes(FileExt)) {
                            console.log(`${file.name}文件格式合法`);
                            return true;
                        } else {
                            this.$message.error(`文件格式不正确!`);
                            return false;
                        }
                    }
                },
                //超出文件个数的回调
                handleExceed() {
                    this.$message({
                        type: 'warning',
                        message: '超出最大上传文件数量的限制！'
                    }); return
                },
                // 上传文件
                async uploadFile(item) {
                    this.file = item.file
                    const formData = new FormData();
                    formData.append('file', this.file, encodeURIComponent(this.file.name));
                    try {
                        const response = await axios.post('/upload', formData, {
                            headers: {
                                Authorization: localStorage.getItem('token')
                            }
                        });
                        if (response.status === 200) {
                            this.$message({
                                message: '上传成功',
                                type: 'success'
                            });
                            // 刷新文件列表
                            // this.getFileList()
                            this.fileList.push(response.data);
                        } else {
                            this.$message.error('上传失败')

                        }
                    } catch (error) {
                        this.$message.error('上传失败', error)
                    }
                },
                // 删除
                async handleDelete(index, row) {
                    try {
                        const response = await axios.post('/files/delete', row, {
                            headers: {
                                Authorization: localStorage.getItem('token')
                            }
                        });
                        if (response.status === 200) {
                            this.$message({
                                message: '删除成功',
                                type: 'success'
                            });
                            // 刷新文件列表
                            this.fileList = this.fileList.filter(file => file.timestamp != row.timestamp)
                            if (row.timestamp == this.rFile.timestamp) this.rFile = {timestamp:null};//若删除的是选择的的文件，解除选中
                        } else {
                            this.$message.error('删除失败')
                        }
                    } catch (error) {
                        // this.$message.error('删除失败')
                    }
                },
                // 打印
                async printFile() {
                    if (!this.rFile) {
                        return this.$message({
                            message: '请先选择文件',
                            type: 'warning'
                        });
                    }

                    try {
                        const response = await axios.post('/print', this.rFile, {
                            headers: {
                                Authorization: localStorage.getItem('token')
                            }
                        });
                        if (response.status === 200) {
                            // 获取页数
                            this.pages = response.data.pages;
                            console.log("pages:" + this.pages);

                            this.$message({
                                message: '打印成功',
                                type: 'success'
                            });
                        } else {
                            this.$message.error('打印失败');
                        }
                    } catch (error) {
                        console.log(error)
                        this.$message.error('打印失败');
                    }
                },
                async login() {
                    window.location.href = "./login.html"
                },
                // 获取所有文件的文件名
                async getFileList() {
                    try {
                        const response = await axios.get('/files/allFiles', {
                            headers: {
                                Authorization: localStorage.getItem('token')
                            }
                        });
                        if (response.status === 200) {
                            this.$message({
                                message: '文件获取成功',
                                type: 'success'
                            });
                            this.fileList = response.data;
                        } else {
                            this.$message.error('文件获取失败')
                        }
                    } catch (error) {
                        this.$message.error('文件获取失败')
                    }
                },
                logout() {
                    this.$message({
                        message: '退出登录',
                        type: 'warning'
                    });
                    localStorage.removeItem('token');
                    this.isLogin = 0;
                    setTimeout(()=>{
                        location.reload();
                    },1000);
                }

            },
            async mounted() {
                try {
                    const response = await axios.get('/vertify', {
                        headers: {
                            Authorization: localStorage.getItem('token')
                        }
                    });
                    if (response.status === 200) {
                        this.$message({
                            message: '自动登录成功',
                            type: 'success'
                        });
                        this.isLogin = 1;
                        this.username = response.data.username;
                        // 刷新文件列表
                        this.getFileList();
                    } else {
                        // this.$message.error('失败')
                    }
                } catch (error) {
                    // this.$message.error('获取失败')
                }
            }

        });
    </script>
</body>

</html>